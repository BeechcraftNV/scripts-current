#!/bin/bash
# update-glam: A "Charm-ified" version of your update script

# Exit on error
set -e

# Tracking arrays
declare -a UPDATED_ITEMS=()
declare -a SKIPPED_ITEMS=()

# Temporary files for capturing output
APT_OUTPUT=$(mktemp)
FLAT_SYS=$(mktemp)
CLEAN_OUT=$(mktemp)
trap 'rm -f $APT_OUTPUT $FLAT_SYS $CLEAN_OUT' EXIT

# --- 1. APT UPDATES ---
gum style --foreground 212 "Û∞ö∞ Starting APT Update..."
# gum spin hides the messy output but runs the command
gum spin --spinner dot --title "Refreshing package lists..." -- sudo apt update 2>&1 > "$APT_OUTPUT"

UPGRADABLE=$(apt list --upgradable 2>/dev/null | grep -v "Listing..." | wc -l)

if [ "$UPGRADABLE" -gt 0 ]; then
    gum style --foreground 43 "üì¶ $UPGRADABLE packages ready for upgrade."
    if gum confirm "Apply APT upgrades?"; then
        gum spin --spinner pulse --title "Upgrading packages..." -- sudo apt full-upgrade -y 2>&1 >> "$APT_OUTPUT"
        UPDATED_ITEMS+=("APT: $UPGRADABLE packages upgraded")
    else
        SKIPPED_ITEMS+=("APT Upgrades (User cancelled)")
    fi
else
    SKIPPED_ITEMS+=("APT (Already up to date)")
fi

# --- 2. FLATPAK UPDATES ---
gum style --foreground 212 "Û∞èñ Checking Flatpaks..."
if gum spin --spinner dot --title "Checking for Flatpak updates..." -- flatpak update --sysadmin --non-interactive --dry-run > "$FLAT_SYS" 2>&1; then
    # If dry-run finds something, it will be in the output
    if [ -s "$FLAT_SYS" ]; then
        gum spin --spinner pulse --title "Updating Flatpaks..." -- sudo flatpak update -y
        UPDATED_ITEMS+=("Flatpaks updated")
    else
        SKIPPED_ITEMS+=("Flatpaks (No updates)")
    fi
fi

# --- 3. KERNEL CHECK ---
RUNNING_KERNEL=$(uname -r | cut -d'-' -f1,2)
INSTALLED_KERNEL=$(dpkg -l | grep "^ii.*linux-image-[0-9]" | sort -V | tail -1 | awk '{print $2}' | sed 's/linux-image-//')

# --- 4. FINAL REPORT (The Glow/Gum Finale) ---
# We build a Markdown string to feed into Glow
REPORT="# üöÄ System Update Report\n\n"

if [ ${#UPDATED_ITEMS[@]} -eq 0 ]; then
    REPORT+="> **Everything was already up to date!**\n\n"
else
    REPORT+="### ‚úÖ Successfully Updated\n"
    for item in "${UPDATED_ITEMS[@]}"; do REPORT+="* $item\n"; done
    REPORT+="\n"
fi

REPORT+="### ‚è≠Ô∏è  Skipped / No Action\n"
for item in "${SKIPPED_ITEMS[@]}"; do REPORT+="* $item\n"; done

REPORT+="\n---\n"
REPORT+="### üêß Kernel Status\n"
REPORT+="* **Running:** \`$RUNNING_KERNEL\`\n"
REPORT+="* **Latest:** \`$INSTALLED_KERNEL\`\n\n"

# Add a high-visibility warning if reboot is needed
if [ "$RUNNING_KERNEL" != "$INSTALLED_KERNEL" ]; then
    REBOOT_MSG=$(gum style --foreground 196 --bold --border rounded --padding "1 2" --margin 1 "‚ö†Ô∏è REBOOT REQUIRED TO LOAD NEW KERNEL")
else
    REBOOT_MSG=$(gum style --foreground 46 "‚úî Running latest kernel")
fi

# Clear screen and show the beautiful results
clear
echo -e "$REPORT" | glow -
echo -e "$REBOOT_MSG"

# Pro-active Tip using gum choose
echo ""
TINKER=$(gum choose --header "Want to do some manual maintenance?" "Update Pip" "Clean APT Cache" "None")

case $TINKER in
    "Update Pip")
        pip list --outdated
        ;;
    "Clean APT Cache")
        gum spin --title "Cleaning..." -- sudo apt autoremove -y
        ;;
esac

gum style --faint "Update complete. Have a great day!"

#!/bin/bash
# Save as ~/.local/bin/update-all
# Comprehensive system update script with Gemini pre-fetch and AI tool reporting

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Arrays to track what happened
declare -a UPDATED_ITEMS=()
declare -a SKIPPED_ITEMS=()
declare -a FAILED_ITEMS=()
declare -a AVAILABLE_NOT_RUN=()
declare -a AI_TOOLS=()

# Temporary files for capturing output
APT_OUTPUT=$(mktemp)
FLATPAK_USER_OUTPUT=$(mktemp)
CLEANUP_OUTPUT=$(mktemp)

# Clear the display
clear

# Function to display the final report
show_report() {
    echo -e "\n"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                     UPDATE SUMMARY REPORT                      â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    echo -e "\n${GREEN}âœ… UPDATED (Core System):${NC}"
    if [ "${#UPDATED_ITEMS[@]}" -eq 0 ]; then
        echo "  â€¢ Nothing was updated"
    else
        for item in "${UPDATED_ITEMS[@]}"; do echo "  â€¢ $item"; done
    fi

    echo -e "\n${BLUE}ðŸ¤– AI & DEVELOPMENT TOOLS:${NC}"
    if [ "${#AI_TOOLS[@]}" -eq 0 ]; then
        echo "  â€¢ No tool updates detected"
    else
        for tool in "${AI_TOOLS[@]}"; do echo "  â€¢ $tool"; done
    fi

    echo -e "\n${BLUE}â­ï¸  SKIPPED (Already Current):${NC}"
    if [ "${#SKIPPED_ITEMS[@]}" -eq 0 ]; then
        echo "  â€¢ No items skipped"
    else
        for item in "${SKIPPED_ITEMS[@]}"; do echo "  â€¢ $item"; done
    fi

    if [ "${#FAILED_ITEMS[@]}" -gt 0 ]; then
        echo -e "\n${RED}âŒ FAILED:${NC}"
        for item in "${FAILED_ITEMS[@]}"; do echo "  â€¢ $item"; done
    fi

    if [ "${#AVAILABLE_NOT_RUN[@]}" -gt 0 ]; then
        echo -e "\n${YELLOW}âš ï¸  MANUAL UPDATES REQUIRED:${NC}"
        for item in "${AVAILABLE_NOT_RUN[@]}"; do echo "  â€¢ $item"; done
    fi

    # Impact assessment
    echo -e "\n${BLUE}ðŸ“Š SYSTEM IMPACT ASSESSMENT:${NC}"
    TOTAL_UPDATED=$(echo "${UPDATED_ITEMS[@]}" | grep -o "[0-9]\+" | awk '{s+=$1} END {print s+0}' || echo "0")

    if [ "$TOTAL_UPDATED" -eq 0 ]; then
        echo "  âš¡ Impact: NONE - System was already fully updated"
    elif [ "$TOTAL_UPDATED" -lt 10 ]; then
        echo "  âš¡ Impact: LOW - Minor updates applied"
    else
        echo "  âš¡ Impact: MODERATE - Significant updates applied"
    fi

    # Kernel check
    RUNNING_KERNEL=$(uname -r)
    INSTALLED_KERNEL=$(dpkg -l | grep "^ii.*linux-image-[0-9]" | grep -v "linux-image-extra" | sort -V | tail -1 | awk '{print $2}' | sed 's/linux-image-//')

    if [ "$RUNNING_KERNEL" != "$INSTALLED_KERNEL" ]; then
        echo -e "  ${RED}âœ– KERNEL MISMATCH: REBOOT REQUIRED${NC}"
    else
        echo -e "  ${GREEN}âœ“ Running the latest kernel ($RUNNING_KERNEL)${NC}"
    fi

    echo -e "\nâœ… Update and Cleanup Complete."
}

# Cleanup temp files and show report on exit
trap 'rm -f "$APT_OUTPUT" "$FLATPAK_USER_OUTPUT" "$CLEANUP_OUTPUT"; show_report' EXIT

# --- SILENT BACKGROUND UPDATES ---
# Pre-warm the Gemini CLI cache in the background 
if command -v npx &> /dev/null; then
    echo "Checking for Gemini CLI updates in background..."
    npx @google/gemini-cli@latest --version > /dev/null 2>&1 &
    GEMINI_PID=$!
fi

echo "=== Updating APT packages ==="
if sudo apt-get update 2>&1 | tee "$APT_OUTPUT"; then
    UPGRADABLE=$(apt-get upgrade --dry-run 2>/dev/null | grep -c "^Inst" || echo "0")

    if [ "$UPGRADABLE" -gt 0 ]; then
        if sudo apt-get full-upgrade -y 2>&1 | tee -a "$APT_OUTPUT"; then
            UPDATED_ITEMS+=("APT: $UPGRADABLE packages upgraded")
        else
            FAILED_ITEMS+=("APT: Upgrade failed after updating package lists")
        fi
    else
        SKIPPED_ITEMS+=("APT: No packages needed updating")
    fi
else
    echo "âš ï¸ APT package list update failed, skipping upgrade."
    FAILED_ITEMS+=("APT: Failed to update package lists")
fi

echo -e "\n=== Updating User Flatpaks ==="
if flatpak update -y 2>&1 | tee "$FLATPAK_USER_OUTPUT"; then
    if grep -q "Nothing to do" "$FLATPAK_USER_OUTPUT"; then
        SKIPPED_ITEMS+=("User Flatpak: Already up to date")
    else
        USER_UPDATES=$(grep -c "Installing\|Updating" "$FLATPAK_USER_OUTPUT" || true)
        if [ "$USER_UPDATES" -gt 0 ]; then
            UPDATED_ITEMS+=("User Flatpak: $USER_UPDATES packages updated")
        else
            UPDATED_ITEMS+=("User Flatpak: Updates applied")
        fi
    fi
else
    FAILED_ITEMS+=("User Flatpak: Update failed")
fi

echo -e "\n=== Cleaning up unused packages and runtimes ==="
AUTOREMOVE_COUNT=$(sudo apt-get autoremove --dry-run 2>/dev/null | grep -c "^Remv" 2>/dev/null || echo "0")
if [ "$AUTOREMOVE_COUNT" -gt 0 ]; then
    if sudo apt-get autoremove -y; then
        UPDATED_ITEMS+=("APT cleanup: Removed $AUTOREMOVE_COUNT orphaned packages")
    else
        FAILED_ITEMS+=("APT cleanup: Failed to remove orphaned packages")
    fi
else
    SKIPPED_ITEMS+=("APT cleanup: No orphaned packages")
fi

echo "Running flatpak repair (user)..."
if flatpak repair --user 2>&1 | tee -a "$CLEANUP_OUTPUT"; then
    AI_TOOLS+=("Flatpak repair: Completed successfully")
else
    FAILED_ITEMS+=("Flatpak repair: Failed")
fi

UNUSED_USER_FLATPAKS=$(flatpak uninstall --user --unused --dry-run 2>/dev/null | grep -c "^[[:space:]]*[0-9]" 2>/dev/null || echo "0")

if [ "$UNUSED_USER_FLATPAKS" -gt 0 ]; then
    if flatpak uninstall --user --unused -y; then
        UPDATED_ITEMS+=("Flatpak cleanup: Removed $UNUSED_USER_FLATPAKS unused runtimes/SDKs")
    else
        FAILED_ITEMS+=("Flatpak cleanup: Failed to remove unused runtimes")
    fi
else
    SKIPPED_ITEMS+=("Flatpak cleanup: No unused runtimes")
fi

# Check for other update sources
echo -e "\n=== Checking AI & Development Tools ==="
if [ -n "$GEMINI_PID" ]; then
    wait $GEMINI_PID
    AI_TOOLS+=("Gemini CLI: Background update check/download complete")
fi

if command -v docker &> /dev/null; then
    OUTDATED_IMAGES=$(docker images --filter "dangling=true" -q 2>/dev/null | wc -l || echo "0")
    if [ "$OUTDATED_IMAGES" -gt 0 ]; then
        AI_TOOLS+=("Docker: $OUTDATED_IMAGES dangling images available for cleanup")
    fi
fi

# Check for firmware updates
if command -v fwupdmgr &> /dev/null; then
    if fwupdmgr refresh &>/dev/null; then
        if ! fwupdmgr get-updates 2>&1 | grep -q "No updates available"; then
            AVAILABLE_NOT_RUN+=("Firmware updates available (run: fwupdmgr update)")
        fi
    fi
fi

# Report will be displayed automatically on exit via trap
